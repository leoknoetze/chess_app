<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web Chess — No External Libs + AI</title>
  <style>
    :root { --sq:64px; --light:#eedcc6; --dark:#7a5230; --hl-move:rgba(255,215,0,.75); --hl-sel:rgba(80,160,255,.75); --text:#222; }
    html, body { height: 100%; margin: 0; }
    body { font-family: Arial, sans-serif; color: var(--text); display: grid; place-items: start center; gap: 12px; padding: 16px; }
    #hud { display:flex; gap:8px; align-items:center; flex-wrap:wrap; max-width:680px; }
    #status { font-weight: bold; }
    button { padding:6px 12px; cursor:pointer; border:1px solid #444; background:#f8f8f8; }
    button:hover { background:#eee; }
    #wrap { display:grid; grid-template-columns:auto; gap:10px; justify-items:center; width:100%; }
    #board { display:grid; grid-template-columns:repeat(8,var(--sq)); grid-template-rows:repeat(8,var(--sq));
             border:2px solid #333; user-select:none; width:calc(var(--sq)*8); height:calc(var(--sq)*8); background:#0001; }
    .sq { width:var(--sq); height:var(--sq); display:grid; place-items:center; font-size:40px; cursor:pointer; }
    .light { background:var(--light); } .dark { background:var(--dark); color:white; }
    .sel { box-shadow: inset 0 0 0 4px var(--hl-sel); } .target { box-shadow: inset 0 0 0 4px var(--hl-move); }
    .check { outline: 4px solid #e53935; outline-offset: -4px; } /* king in check */
    #analysis, #io, #review { max-width:680px; border:1px solid #ddd; padding:10px; border-radius:6px; width:100%; }
    #analysis .muted { opacity:.7; }
    textarea { width:100%; font-family: Consolas, monospace; }
    label { display:block; margin-top:6px; }
    #io h3 { margin:0 0 8px 0; } #io .row { display:grid; grid-template-columns:1fr; gap:8px; }

    /* Timers */
    #timers { display:flex; gap:10px; align-items:center; }
    .timer { padding:6px 10px; border:1px solid #444; border-radius:6px; min-width:110px; text-align:center; font-weight:bold; }
    .timer.w { background:#fff; }
    .timer.b { background:#222; color:#fff; }
    .small { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="hud">
  <span id="status">Status: {{ status }}</span>

  <!-- single-player controls -->
  <button id="resetBtn" type="button">Reset</button>
  <button id="suggestBtn" type="button">Suggest Move</button>
  <button id="aiMoveBtn" type="button">AI Move</button>

  <!-- navigation to multiplayer -->
  <a href="/multi" style="text-decoration:none;">
    <button type="button">Multiplayer ▶</button>
  </a>
</div>


    <div id="timers">
      <div class="timer w" id="tw">White: <span id="twv">05:00</span></div>
      <div class="timer b" id="tb">Black: <span id="tbv">05:00</span></div>
      <span class="small">Time control:</span>
      <select id="tcPreset">
        <option value="5,0">5+0</option>
        <option value="10,0">10+0</option>
        <option value="15,10">15+10</option>
        <option value="3,2">3+2</option>
      </select>
      <button id="applyTcBtn" type="button">Apply</button>
      <button id="startClkBtn" type="button">Start</button>
      <button id="pauseClkBtn" type="button">Pause</button>
    </div>

    <div id="board" aria-label="Chessboard"></div>

    <div id="analysis">
      <strong>Analysis</strong>
      <div class="muted">Click “Suggest Move” or “AI Move”. If Stockfish isn’t found, you’ll see a friendly message.</div>
    </div>

    <div id="io">
      <h3>Import / Export</h3>
      <div class="row">
        <label for="fenInput"><b>FEN</b> (paste a position string):</label>
        <textarea id="fenInput" rows="2" placeholder="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"></textarea>
        <div>
          <button id="loadFenBtn" type="button">Load FEN</button>
          <button id="copyFenBtn" type="button">Copy Current FEN</button>
        </div>

        <label for="pgnInput"><b>PGN</b> (paste a full game, e.g., from chess.com export):</label>
        <textarea id="pgnInput" rows="8" placeholder='[Event "Live Chess"]&#10;1. e4 e5 2. Nf3 Nc6 ...'></textarea>
        <div>
          <button id="loadPgnBtn" type="button">Load PGN</button>
          <a id="downloadPgnLink" href="/export_pgn"><button type="button">Download Current PGN</button></a>
        </div>
        <div style="margin-top:8px;">
          <button id="reviewPgnBtn" type="button">Review PGN (from box)</button>
          <button id="reviewCurrentBtn" type="button">Review Current Game</button>
        </div>
      </div>
    </div>

    <div id="review">
      <h3>Review</h3>
      <div class="muted">Run a review to see per-move feedback.</div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const pieceMap = {'P':'♙','N':'♘','B':'♗','R':'♖','Q':'♕','K':'♔','p':'♟','n':'♞','b':'♝','r':'♜','q':'♛','k':'♚'};
    const files = ['a','b','c','d','e','f','g','h'];
    function idxToSquare(r, c) { return files[c] + String(8 - r); }
    function fenToBoard(fen) {
      const rows = fen.split(' ')[0].split('/'); const board = [];
      for (const row of rows) { const out = [];
        for (const ch of row) { if (/[1-8]/.test(ch)) out.push(...Array(parseInt(ch)).fill(' ')); else out.push(pieceMap[ch] || ' '); }
        board.push(out);
      }
      return board;
    }
    function fmt(ms) {
      if (ms == null) return '--:--';
      ms = Math.max(0, Math.floor(ms));
      const s = Math.floor(ms / 1000), m = Math.floor(s / 60), r = s % 60;
      return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
    }

    // ---------- DOM ----------
    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const analysisEl = document.getElementById('analysis');

    // ---------- State ----------
    let fen = "{{ fen }}";
    if (!fen || fen.indexOf('/') === -1) fen = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";
    let gameOver = false;
    let selected = null;
    let legalTargets = new Set();
    let pollId = null;

    // ---------- Renderers ----------
    function renderBoard(f) {
      boardEl.innerHTML = '';
      const grid = fenToBoard(f);
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const div = document.createElement('div');
          div.className = 'sq ' + ((r + c) % 2 === 0 ? 'light' : 'dark');
          div.dataset.square = idxToSquare(r, c);
          div.textContent = grid[r][c];
          boardEl.appendChild(div);
        }
      }
    }
    function renderClocks(clocks) {
      if (!clocks) return;
      document.getElementById('twv').textContent = fmt(clocks.w_ms);
      document.getElementById('tbv').textContent = fmt(clocks.b_ms);
    }
    function applyFlags(flags) {
      gameOver = !!(flags && flags.game_over);
      document.querySelectorAll('#board .sq').forEach(el => el.classList.remove('check'));
      if (flags && flags.check && flags.check_square) {
        const el = document.querySelector(`#board [data-square="${flags.check_square}"]`);
        if (el) el.classList.add('check');
      }
      if (flags) {
        if (flags.mate) statusEl.textContent = 'Status: Checkmate';
        else if (flags.game_over) statusEl.textContent = `Status: Game Over${flags.result ? ' (' + flags.result + ')' : ''}`;
        else if (flags.check) statusEl.textContent = 'Status: Check';
      }
    }

    // ---------- Polling ----------
    async function pollState() {
      try {
        const r = await fetch('/state');
        const d = await r.json();
        if (d.flags) applyFlags(d.flags);
        if (d.clocks) {
          renderClocks(d.clocks);
          if (d.clocks.flagged) {
            gameOver = true;
            const res = d.flags && d.flags.result ? ` (${d.flags.result})` : '';
            statusEl.textContent = 'Status: Game Over (time)' + res;
          }
        }
      } catch {}
    }
    function startPolling() { if (!pollId) pollId = setInterval(pollState, 500); }
    function stopPolling()  { if (pollId) { clearInterval(pollId); pollId = null; } }

    // ---------- Move selection ----------
    function clearHighlights() {
      boardEl.querySelectorAll('.sq').forEach(el => el.classList.remove('sel','target'));
      legalTargets.clear();
    }
    async function showLegalTargets(fromSquare, sourceEl) {
      if (gameOver) return;
      try {
        const res = await fetch(`/legal/${fromSquare}`);
        const data = await res.json();
        clearHighlights();
        sourceEl.classList.add('sel');
        data.legal.forEach(t => {
          legalTargets.add(t);
          const el = boardEl.querySelector(`[data-square="${t}"]`);
          if (el) el.classList.add('target');
        });
      } catch (e) { console.error(e); }
    }
    async function submitMove(uci) {
      try {
        const res = await fetch('/move', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ move: uci })
        });
        const data = await res.json();

        if (!data.success) {
          if (data.flags) applyFlags(data.flags);
          if (data.clocks) renderClocks(data.clocks);
          alert(data.error || 'Illegal move');
          return;
        }

        fen = data.fen;
        renderBoard(fen);
        statusEl.textContent = 'Status: ' + data.status;
        if (data.flags) {
          applyFlags(data.flags);
          if (data.flags.game_over) {
            const r = data.flags.result ? ` (${data.flags.result})` : '';
            setTimeout(() => alert('Game over' + r), 0);
          }
        }
        if (data.clocks) renderClocks(data.clocks);
      } catch { alert('Network error submitting move'); }
    }

    // ---------- Events ----------
    boardEl.addEventListener('click', async (e) => {
      if (gameOver) return;
      const el = e.target.closest('.sq'); if (!el) return;
      const sq = el.dataset.square;
      if (!selected) { selected = sq; await showLegalTargets(sq, el); return; }
      if (legalTargets.has(sq)) { await submitMove(selected + sq); }
      selected = null; clearHighlights();
    });

    document.getElementById('resetBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/reset', { method: 'POST' });
        const data = await res.json();
        if (data.success === false) { alert(data.error || 'Reset failed'); return; }
        fen = data.fen; renderBoard(fen);
        statusEl.textContent = 'Status: ' + data.status;
        selected = null; clearHighlights(); gameOver = false;
        if (data.flags) applyFlags(data.flags);
        if (data.clocks) renderClocks(data.clocks);
        analysisEl.innerHTML = '<strong>Analysis</strong><div class="muted">Board reset.</div>';
      } catch (e) { alert('Network error on reset'); console.error(e); }
    });

    // Time controls
    document.getElementById('applyTcBtn').addEventListener('click', async () => {
      const val = document.getElementById('tcPreset').value;
      const [minutes, inc] = val.split(',').map(x => parseInt(x, 10));
      const res = await fetch('/clock/config', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ minutes, increment: inc, turn: 'w' })
      });
      const data = await res.json();
      if (data.clocks) renderClocks(data.clocks);
    });
    document.getElementById('startClkBtn').addEventListener('click', async () => {
      const res = await fetch('/clock/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
      const data = await res.json();
      if (data.clocks) renderClocks(data.clocks);
    });
    document.getElementById('pauseClkBtn').addEventListener('click', async () => {
      const res = await fetch('/clock/pause', { method:'POST' });
      const data = await res.json();
      if (data.clocks) renderClocks(data.clocks);
    });

    // AI
    document.getElementById('suggestBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/ai/suggest', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: '{}' });
        const data = await res.json();
        if (!data.success) { analysisEl.innerHTML = `<strong>Analysis</strong><div>Engine unavailable: ${data.error || 'unknown error'}</div>`; return; }
        const s = data.suggestion;
        let evalText = '';
        if (s.eval) evalText = s.eval.type === 'mate' ? `Mate in ${s.eval.value}` : `Eval: ${(s.eval.value/100).toFixed(2)} pawns`;
        analysisEl.innerHTML = `
          <strong>Analysis</strong>
          <div><b>Best move:</b> ${s.bestmove || '(none)'}</div>
          <div><b>Line (SAN):</b> ${(s.pv_san || []).join(' ')}</div>
          <div><b>${evalText}</b></div>
          <div class="muted">Engine: ${s.engine?.version || ''}</div>`;
      } catch { analysisEl.innerHTML = `<strong>Analysis</strong><div>Network error.</div>`; }
    });
    document.getElementById('aiMoveBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/ai/play', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: '{}' });
        const data = await res.json();
        if (!data.success) { analysisEl.innerHTML = `<strong>Analysis</strong><div>Engine unavailable: ${data.error || 'unknown error'}</div>`; return; }
        fen = data.fen; renderBoard(fen);
        const a = data.ai?.analysis, played = data.ai?.move || '';
        let evalText = '';
        if (a?.eval) evalText = (a.eval.type === 'mate') ? `Mate in ${a.eval.value}` : `Eval: ${(a.eval.value/100).toFixed(2)} pawns`;
        analysisEl.innerHTML = `
          <strong>Analysis</strong>
          <div><b>Engine played:</b> ${played}</div>
          <div><b>Line (SAN):</b> ${(a?.pv_san || []).join(' ')}</div>
          <div><b>${evalText}</b></div>
          <div class="muted">Engine: ${a?.engine?.version || ''}</div>`;
        statusEl.textContent = 'Status: Ongoing';
        // refresh flags & clocks
        try { const s = await fetch('/state'); const ss = await s.json(); if (ss.flags) applyFlags(ss.flags); if (ss.clocks) renderClocks(ss.clocks); } catch {}
      } catch { analysisEl.innerHTML = `<strong>Analysis</strong><div>Network error.</div>`; }
    });

    // ---------- Init ----------
    renderBoard(fen);
    (async () => {
      try { const r = await fetch('/state'); const d = await r.json(); if (d.flags) applyFlags(d.flags); if (d.clocks) renderClocks(d.clocks); } catch {}
    })();
    startPolling();
  </script>
</body>=
</html>
=